version: '3.8'

services:
  crittercatcher:
    build: .
    image: crittercatcher-ai:latest
    container_name: crittercatcher-ai
    restart: unless-stopped
    
    # Environment variables
    environment:
      - RING_USERNAME=${RING_USERNAME}
      - RING_PASSWORD=${RING_PASSWORD}
      - RUN_ONCE=false
      - TZ=America/New_York
      - WEB_PORT=8080
      - PUID=99
      - PGID=100
      - UMASK=0000
    
    # Volume mappings for Unraid
    volumes:
      # Configuration (read-write so web UI can update settings)
      # Maps to /config inside container (matching Unraid template)
      - ./config:/config
      
      # Main data directory - contains all application data
      # This should be on a volume with sufficient space for video frames and training data
      - /mnt/user/appdata/crittercatcher:/data
      
      # Alternative: Split volumes for better performance
      # Uncomment below and comment out /data above if needed:
      # - /mnt/user/appdata/crittercatcher/profiles:/data/animal_profiles
      # - /mnt/user/appdata/crittercatcher/sorted:/data/sorted
      # - /mnt/user/appdata/crittercatcher/review:/data/review
      # - /mnt/user/appdata/crittercatcher/training:/data/training
      # - /mnt/user/appdata/crittercatcher/models:/data/models
    
    # Optional: GPU support for faster inference
    # Uncomment if you have NVIDIA GPU and nvidia-docker installed
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: 1
    #           capabilities: [gpu]
    # Alternatively (Compose v2):
    # device_requests:
    #   - driver: nvidia
    #     count: 1
    #     capabilities: [gpu]
    
    # Network mode
    network_mode: bridge
    
    # Ports
    ports:
      - "8080:8080"
    
    # Healthcheck
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
